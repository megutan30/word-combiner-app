<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>単語組み合わせアプリ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            text-align: center;
            padding: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .content {
            padding: 40px;
        }

        .mode-selector {
            background: linear-gradient(135deg, #a8e6cf, #88d8a3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .mode-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .mode-btn {
            background: white;
            border: 3px solid #88d8a3;
            color: #2d3436;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .mode-btn.active {
            background: #00b894;
            color: white;
            border-color: #00a085;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 184, 148, 0.3);
        }

        .mode-btn:hover:not(.active) {
            background: #f8f9fa;
            transform: translateY(-1px);
        }

        .box-count-selector {
            background: linear-gradient(135deg, #fdcb6e, #f39c12);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .box-count-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .box-count-btn {
            background: white;
            border: 2px solid #f39c12;
            color: #2d3436;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            min-width: 50px;
        }

        .box-count-btn:hover {
            background: #f39c12;
            color: white;
            transform: translateY(-1px);
        }

        .box-count-display {
            background: white;
            border: 3px solid #f39c12;
            color: #2d3436;
            padding: 12px 24px;
            border-radius: 15px;
            font-size: 20px;
            font-weight: bold;
            min-width: 80px;
            text-align: center;
        }

        .section {
            margin-bottom: 40px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #ff6b6b;
            padding-bottom: 10px;
        }

        .category-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .category-tab {
            background: #f1f2f6;
            border: 2px solid #ddd;
            color: #2d3436;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            font-size: 14px;
            white-space: nowrap;
        }

        .category-tab.active {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border-color: #ff6b6b;
        }

        .category-tab:hover:not(.active) {
            background: #e8e9ea;
        }

        .input-mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .input-mode-btn {
            background: #f1f2f6;
            border: 2px solid #ddd;
            color: #2d3436;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            font-size: 14px;
        }

        .input-mode-btn.active {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
            border-color: #00b894;
        }

        .input-mode-btn:hover:not(.active) {
            background: #e8e9ea;
        }

        .bulk-input-section {
            margin-bottom: 20px;
        }

        .bulk-input {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
            margin-bottom: 10px;
        }

        .bulk-input:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        .bulk-input-controls {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .clear-btn {
            background: linear-gradient(135deg, #636e72, #2d3436);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .clear-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(99, 110, 114, 0.3);
        }

        .word-input-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .word-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .word-input:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        .add-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(255, 107, 107, 0.3);
        }

        .word-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            min-height: 50px;
            padding: 15px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            background: #f9f9f9;
        }

        .word-tag {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: fadeIn 0.3s;
        }

        .word-tag.box1 { background: linear-gradient(135deg, #ff7675, #e17055); }
        .word-tag.box2 { background: linear-gradient(135deg, #6c5ce7, #a29bfe); }
        .word-tag.box3 { background: linear-gradient(135deg, #00b894, #00a085); }
        .word-tag.box4 { background: linear-gradient(135deg, #fdcb6e, #f39c12); }
        .word-tag.box5 { background: linear-gradient(135deg, #e84393, #d63031); }
        .word-tag.box6 { background: linear-gradient(135deg, #fd79a8, #e84393); }
        .word-tag.box7 { background: linear-gradient(135deg, #74b9ff, #0984e3); }
        .word-tag.box8 { background: linear-gradient(135deg, #a29bfe, #6c5ce7); }
        .word-tag.box9 { background: linear-gradient(135deg, #55a3ff, #3742fa); }
        .word-tag.box10 { background: linear-gradient(135deg, #26de81, #20bf6b); }

        .word-tag .remove-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .list-controls {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .preset-btn {
            background: linear-gradient(135deg, #8e44ad, #7d3c98);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .preset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(142, 68, 173, 0.3);
        }

        .bulk-select-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .bulk-select-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .bulk-select-btn.active {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .bulk-delete-section {
            background: #ffe6e6;
            border: 2px solid #ffcccc;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .bulk-delete-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .select-all-btn, .deselect-all-btn, .cancel-selection-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .select-all-btn:hover, .deselect-all-btn:hover, .cancel-selection-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .delete-selected-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }

        .delete-selected-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .delete-selected-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .word-tag.selectable {
            cursor: pointer;
            position: relative;
        }

        .word-tag.selectable:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .word-tag.selected {
            background: linear-gradient(135deg, #e74c3c, #c0392b) !important;
            transform: scale(0.95);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .word-tag .selection-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .preset-panel {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #8e44ad;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 10px 30px rgba(142, 68, 173, 0.1);
        }

        .preset-panel h4 {
            color: #8e44ad;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.2em;
        }

        .preset-panel h5 {
            color: #6c757d;
            margin: 15px 0 10px 0;
            font-size: 1em;
        }

        .preset-save-section, .preset-load-section {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
        }

        .preset-save-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .preset-save-controls input {
            flex: 1;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .preset-save-controls input:focus {
            outline: none;
            border-color: #8e44ad;
        }

        .save-preset-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .save-preset-btn:hover {
            background: linear-gradient(135deg, #20c997, #17a2b8);
            transform: translateY(-1px);
        }

        .current-preset-info {
            font-size: 0.9em;
            color: #6c757d;
            font-style: italic;
        }

        .preset-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .no-presets {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
        }

        .preset-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .preset-item:hover {
            background: #e9ecef;
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .preset-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .preset-name {
            font-weight: bold;
            color: #495057;
            font-size: 1.1em;
        }

        .preset-info {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .preset-actions {
            display: flex;
            gap: 8px;
        }

        .load-preset-btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .load-preset-btn:hover {
            background: linear-gradient(135deg, #0056b3, #004085);
            transform: translateY(-1px);
        }

        .delete-preset-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .delete-preset-btn:hover {
            background: linear-gradient(135deg, #c82333, #bd2130);
            transform: translateY(-1px);
        }

        .preset-panel-controls {
            text-align: center;
            margin-top: 20px;
        }

        .close-preset-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .close-preset-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .backup-section {
            background: #f0f8ff;
            border: 1px solid #0066cc;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .backup-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .backup-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(0, 102, 204, 0.1);
            border-radius: 8px;
            font-size: 0.9em;
        }

        .auto-backup-status {
            color: #0066cc;
            font-weight: bold;
        }

        .backup-count {
            color: #666;
        }

        .backup-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .manual-backup-btn, .export-backup-btn, .import-backup-btn, .restore-backup-btn {
            background: linear-gradient(135deg, #0066cc, #004499);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            flex: 1;
            min-width: 100px;
        }

        .manual-backup-btn:hover, .export-backup-btn:hover, .import-backup-btn:hover, .restore-backup-btn:hover {
            background: linear-gradient(135deg, #004499, #003366);
            transform: translateY(-1px);
        }

        .backup-list-panel {
            background: linear-gradient(135deg, #f0f8ff, #e6f3ff);
            border: 2px solid #0066cc;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 10px 30px rgba(0, 102, 204, 0.1);
        }

        .backup-list-panel h4 {
            color: #0066cc;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.2em;
        }

        .backup-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .no-backups {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
        }

        .backup-item {
            background: white;
            border: 1px solid #0066cc;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .backup-item:hover {
            background: #f0f8ff;
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 102, 204, 0.2);
        }

        .backup-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .backup-name {
            font-weight: bold;
            color: #0066cc;
            font-size: 1.1em;
        }

        .backup-type {
            background: #0066cc;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .backup-info-detail {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .backup-actions-detail {
            display: flex;
            gap: 8px;
        }

        .restore-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .restore-btn:hover {
            background: linear-gradient(135deg, #20c997, #17a2b8);
            transform: translateY(-1px);
        }

        .delete-backup-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .delete-backup-btn:hover {
            background: linear-gradient(135deg, #c82333, #bd2130);
            transform: translateY(-1px);
        }

        .backup-panel-controls {
            text-align: center;
            margin-top: 20px;
        }

        .close-backup-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .close-backup-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .generate-btn {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-bottom: 30px;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 184, 148, 0.3);
        }

        .generate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .result-section {
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
        }

        .word-boxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }

        @media (max-width: 768px) {
            .word-boxes {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .word-boxes {
                grid-template-columns: 1fr;
            }
        }

        .word-box {
            background: white;
            border: 3px solid;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .word-box.box1 { border-color: #ff7675; }
        .word-box.box2 { border-color: #6c5ce7; }
        .word-box.box3 { border-color: #00b894; }
        .word-box.box4 { border-color: #fdcb6e; }
        .word-box.box5 { border-color: #e84393; }
        .word-box.box6 { border-color: #fd79a8; }
        .word-box.box7 { border-color: #74b9ff; }
        .word-box.box8 { border-color: #a29bfe; }
        .word-box.box9 { border-color: #55a3ff; }
        .word-box.box10 { border-color: #26de81; }

        .word-box:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .word-box.active {
            border-color: #00b894;
            background: #e8f5f0;
        }

        .word-box .word-text {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            word-break: break-word;
        }

        .word-box .hint {
            font-size: 0.8em;
            color: #666;
        }

        .word-box .category-label {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            color: #666;
        }

        .pin-btn {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(255, 193, 7, 0.8);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
        }

        .pin-btn:hover {
            background: rgba(255, 193, 7, 1);
            opacity: 1;
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(255, 193, 7, 0.4);
        }

        .pin-btn.pinned {
            background: rgba(255, 193, 7, 1);
            opacity: 1;
            transform: rotate(45deg);
            box-shadow: 0 3px 10px rgba(255, 193, 7, 0.6);
        }

        .pin-btn:active {
            transform: scale(0.95);
        }

        .pin-btn.pinned:active {
            transform: rotate(45deg) scale(0.95);
        }

        .word-box.pinned {
            border-color: #ffc107;
            background: linear-gradient(135deg, #fff9e6, #fff3cd);
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3);
        }

        .word-box.pinned .hint {
            color: #856404;
            font-weight: bold;
        }

        .dislike-btn {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(255, 99, 71, 0.8);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
        }

        .dislike-btn:hover {
            background: rgba(255, 99, 71, 1);
            opacity: 1;
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(255, 99, 71, 0.4);
        }

        .dislike-btn:active {
            transform: scale(0.95);
        }

        .replacement-panel {
            background: white;
            border: 2px solid #ddd;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            animation: slideDown 0.3s;
        }

        .replacement-words {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .replacement-word {
            background: #f1f2f6;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .replacement-word:hover {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
        }

        .excluded-words-section {
            background: #fff5f5;
            border: 2px solid #ffcccb;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .excluded-words-section h4 {
            color: #dc3545;
            margin-bottom: 10px;
        }

        .excluded-words-section p {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .excluded-words {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .excluded-word {
            background: #f8d7da;
            border: 2px solid #f5c6cb;
            border-radius: 10px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .excluded-word:hover {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .excluded-word::after {
            content: "クリックで復活";
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .excluded-word:hover::after {
            opacity: 1;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .empty-state {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }

            .mode-buttons, .box-count-controls {
                flex-direction: column;
                align-items: center;
            }

            .category-tabs {
                justify-content: center;
            }

            .list-controls {
                flex-direction: column;
                gap: 8px;
            }

            .word-input-section {
                flex-direction: column;
            }

            .preset-save-controls {
                flex-direction: column;
                gap: 8px;
            }

            .preset-actions {
                flex-direction: column;
                gap: 5px;
            }

            .backup-actions {
                flex-direction: column;
                gap: 5px;
            }

            .backup-actions button, .backup-actions label {
                width: 100%;
                min-width: auto;
            }

            .backup-actions-detail {
                flex-direction: column;
                gap: 5px;
            }

            .backup-actions-detail button {
                width: 100%;
            }

            .bulk-delete-controls {
                flex-direction: column;
                gap: 8px;
            }

            .bulk-delete-controls button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎲 単語組み合わせアプリ</h1>
            <p>単語を登録してランダムな組み合わせを楽しもう！</p>
        </div>
        
        <div class="content">
            <!-- モード選択 -->
            <div class="mode-selector">
                <h3>🎯 モード選択</h3>
                <p>単語の管理方法を選択してください</p>
                <div class="mode-buttons">
                    <button class="mode-btn active" onclick="setMode('mixed')">
                        🌈 ミックスモード<br>
                        <small>全ての単語から選択</small>
                    </button>
                    <button class="mode-btn" onclick="setMode('category')">
                        📂 カテゴリモード<br>
                        <small>ボックスごとに専用リスト</small>
                    </button>
                </div>
            </div>

            <!-- ボックス数選択 -->
            <div class="box-count-selector">
                <h3>📦 ボックス数設定</h3>
                <p>組み合わせるボックスの数を選択してください（2～10個）</p>
                <div class="box-count-controls">
                    <button class="box-count-btn" onclick="changeBoxCount(-1)">-</button>
                    <div class="box-count-display" id="boxCountDisplay">2</div>
                    <button class="box-count-btn" onclick="changeBoxCount(1)">+</button>
                </div>
            </div>

            <div class="section">
                <h2>📝 単語を追加</h2>
                
                <!-- カテゴリタブ（カテゴリモードのみ表示） -->
                <div class="category-tabs hidden" id="categoryTabs">
                    <!-- 動的に生成される -->
                </div>
                
                <!-- 単語追加方法の切り替え -->
                <div class="input-mode-selector">
                    <button class="input-mode-btn active" onclick="setInputMode('single')" id="singleModeBtn">
                        ✏️ 個別入力
                    </button>
                    <button class="input-mode-btn" onclick="setInputMode('bulk')" id="bulkModeBtn">
                        📝 まとめて入力
                    </button>
                </div>
                
                <!-- 個別入力モード -->
                <div class="word-input-section" id="singleInputSection">
                    <input type="text" class="word-input" id="wordInput" placeholder="単語を入力してください">
                    <button class="add-btn" onclick="addWord()">追加</button>
                </div>
                
                <!-- まとめて入力モード -->
                <div class="bulk-input-section hidden" id="bulkInputSection">
                    <textarea class="bulk-input" id="bulkInput" placeholder="複数の単語を入力してください（改行、カンマ、スペースで区切り）&#10;例：&#10;美しい&#10;強い, 賢い&#10;優しい 勇敢な"></textarea>
                    <div class="bulk-input-controls">
                        <button class="add-btn" onclick="addBulkWords()">まとめて追加</button>
                        <button class="clear-btn" onclick="clearBulkInput()">クリア</button>
                    </div>
                </div>
                
                <div class="word-list" id="wordList">
                    <div class="empty-state">まだ単語が登録されていません</div>
                </div>
                
                <!-- まとめて削除機能 -->
                <div class="bulk-delete-section" id="bulkDeleteSection" style="display: none;">
                    <div class="bulk-delete-controls">
                        <button class="select-all-btn" onclick="selectAllWords()">全選択</button>
                        <button class="deselect-all-btn" onclick="deselectAllWords()">選択解除</button>
                        <button class="delete-selected-btn" onclick="deleteSelectedWords()" id="deleteSelectedBtn" disabled>
                            選択した単語を削除 (<span id="selectedCount">0</span>個)
                        </button>
                        <button class="cancel-selection-btn" onclick="cancelSelection()">キャンセル</button>
                    </div>
                </div>
                
                <div class="list-controls">
                    <button class="preset-btn" onclick="showPresetPanel()" id="presetBtn">
                        💾 プリセット管理
                    </button>
                    <button class="bulk-select-btn" onclick="toggleBulkSelectMode()" id="bulkSelectBtn">
                        ✅ まとめて削除
                    </button>
                </div>

                <!-- プリセット管理パネル -->
                <div class="preset-panel" id="presetPanel" style="display: none;">
                    <h4>📦 プリセット管理</h4>
                    
                    <!-- 保存セクション -->
                    <div class="preset-save-section">
                        <h5>💾 現在の単語セットを保存</h5>
                        <div class="preset-save-controls">
                            <input type="text" id="presetNameInput" placeholder="プリセット名を入力..." maxlength="50">
                            <button class="save-preset-btn" onclick="saveCurrentPreset()">保存</button>
                        </div>
                        <div class="current-preset-info">
                            <span id="currentWordsCount">0</span>個の単語が保存されます
                        </div>
                    </div>

                    <!-- ロードセクション -->
                    <div class="preset-load-section">
                        <h5>📂 保存済みプリセット</h5>
                        <div class="preset-list" id="presetList">
                            <div class="no-presets">保存されたプリセットはありません</div>
                        </div>
                    </div>

                    <!-- バックアップセクション -->
                    <div class="backup-section">
                        <h5>🛡️ バックアップ管理</h5>
                        <div class="backup-controls">
                            <div class="backup-info">
                                <div class="auto-backup-status" id="autoBackupStatus">
                                    🔄 自動バックアップ: <span id="autoBackupTime">未実行</span>
                                </div>
                                <div class="backup-count">
                                    📦 バックアップ数: <span id="backupCount">0</span>個
                                </div>
                            </div>
                            <div class="backup-actions">
                                <button class="manual-backup-btn" onclick="createManualBackup()">📥 手動バックアップ</button>
                                <button class="export-backup-btn" onclick="exportBackup()">📤 エクスポート</button>
                                <label class="import-backup-btn" for="importFile">📂 インポート
                                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importBackup(event)">
                                </label>
                                <button class="restore-backup-btn" onclick="showBackupList()">🔄 復元</button>
                            </div>
                        </div>
                    </div>

                    <div class="preset-panel-controls">
                        <button class="close-preset-btn" onclick="hidePresetPanel()">閉じる</button>
                    </div>
                </div>

                <!-- バックアップリストパネル -->
                <div class="backup-list-panel" id="backupListPanel" style="display: none;">
                    <h4>🔄 バックアップ復元</h4>
                    <div class="backup-list" id="backupList">
                        <div class="no-backups">バックアップがありません</div>
                    </div>
                    <div class="backup-panel-controls">
                        <button class="close-backup-btn" onclick="hideBackupList()">閉じる</button>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <button class="generate-btn" id="generateBtn" onclick="generateRandomCombination()" disabled>
                    🎯 ランダムな組み合わせを生成
                </button>
                
                <div class="result-section" id="resultSection" style="display: none;">
                    <h3>✨ 今日の組み合わせ</h3>
                    <div class="word-boxes" id="wordBoxes">
                        <!-- 動的に生成される -->
                    </div>
                </div>
                
                <div class="replacement-panel" id="replacementPanel" style="display: none;">
                    <h4>🔄 単語を選択してください</h4>
                    <div class="replacement-words" id="replacementWords"></div>
                </div>

                <!-- 除外された単語の管理 -->
                <div class="excluded-words-section" id="excludedWordsSection" style="display: none;">
                    <h4>🚫 除外された単語</h4>
                    <p>除外された単語はランダム生成に含まれません。クリックで復活できます。</p>
                    <div class="excluded-words" id="excludedWords"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'mixed'; // 'mixed' or 'category'
        let boxCount = 2; // 現在のボックス数
        let activeCategory = 1; // アクティブなカテゴリ（カテゴリモード用）
        let inputMode = 'single'; // 'single' or 'bulk'
        
        // ミックスモード用
        let mixedWords = [];
        let excludedMixedWords = [];
        
        // カテゴリモード用（最大10ボックス分）
        let categoryWords = {};
        let excludedCategoryWords = {};
        
        // 現在の単語とピン状態
        let currentWords = {};
        let pinnedWords = {};
        
        let selectedBox = 0;
        let bulkSelectMode = false;
        let selectedWords = new Set();
        
        // プリセット機能用
        let savedPresets = {};
        let presetCounter = 0;
        
        // バックアップ機能用
        let backupData = {};
        let backupCounter = 0;
        let autoBackupInterval = null;
        let lastAutoBackup = null;

        // 初期単語データ
        const initialWords = {
            mixed: [
                'HP', 'MP', 'ゲージ', '画面', 'コントローラー', 'オプション', 'タイトル', '判定', 'ディスプレイ', 'プレイヤー', 
                '移動', 'スティック', 'ボタン', 'ジャンル', 'ローグライク', '文字', '解像度', 'フォント', 'メニュー', 'インベントリ',
                'エンジン', 'フレームワーク', 'アーキテクチャ', 'プラットフォーム', 'OS', 'ハードウェア', 'CPU', 'GPU', 'メモリ', 'ストレージ', 
                '帯域幅', 'レイテンシ', 'サーバー', 'クライアント', 'ピアツーピア', 'フレームレート', 'V-Sync', 'レンダリング', '描画', '最適化'
            ],
            categories: {
                1: ['HP', 'MP', 'ゲージ', 'ステータス', 'レベル', '経験値', 'スキル', '攻撃力', '防御力', '素早さ', '魔力', '運', 'クリティカル', '回避', '命中', '耐性'],
                2: ['画面', 'メニュー', 'インベントリ', 'HUD', 'ミニマップ', 'アイコン', 'カーソル', 'ツールチップ', 'ダイアログ', 'ポップアップ', 'スライダー', 'チェックボックス'],
                3: ['武器', '防具', 'アクセサリー', '消耗品', '回復アイテム', '素材', '通貨', 'ポーション', 'エリクサー', '鍵', '宝箱', 'レアリティ', '品質', '耐久度', '重量', 'エンチャント'],
                4: ['ワールド', 'ステージ', 'フィールド', 'ダンジョン', '街', '村', '城', '塔', '洞窟', '森', '山', '海', '砂漠', '氷原', '火山', '空'],
                5: ['攻撃', '防御', '魔法', 'スキル発動', 'コンボ', '必殺技', 'ガード', '回復', 'バフ', 'デバフ', '状態異常', '毒', '麻痺', '眠り', '混乱', '先制攻撃'],
                6: ['キャラクター', 'NPC', 'ボス', 'モンスター', 'ドラゴン', 'スライム', 'ゴブリン', 'エルフ', 'ドワーフ', 'アバター', 'カスタマイゼーション', '外見', '服装', '髪型'],
                7: ['クエスト', 'ミッション', '目標', 'チャレンジ', 'パズル', '謎解き', '探索', '収集', '育成', '合成', 'クラフト', '建築', '農業', 'シナリオ', '脚本', '台詞'],
                8: ['BGM', 'SE', 'ボイス', '効果音', '音量', 'ミュート', 'グラフィック', '音響効果', '残響', 'エコー', 'ディストーション', 'フィルター', 'イコライザー', 'コンプレッサー'],
                9: ['セーブ', 'ロード', 'オートセーブ', 'チェックポイント', '進行度', 'クリア', 'ゲームオーバー', 'リスタート', 'コンティニュー', 'ニューゲーム', '周回', 'エンディング'],
                10: ['オンライン', 'オフライン', 'マルチプレイ', '協力プレイ', '対戦', 'ランキング', 'リーダーボード', 'フレンド', 'ギルド', 'チャット', 'ボイスチャット', '接続', '切断']
            }
        };

        // 初期化
        function initializeApp() {
            // 初期単語データを設定
            mixedWords = [...initialWords.mixed];
            
            for (let i = 1; i <= 10; i++) {
                categoryWords[i] = initialWords.categories[i] ? [...initialWords.categories[i]] : [];
                excludedCategoryWords[i] = [];
                currentWords[i] = '';
                pinnedWords[i] = false;
            }
            
            updateUI();
            loadPresets();
            initializeBackupSystem();
        }

        function changeBoxCount(delta) {
            const newCount = boxCount + delta;
            if (newCount >= 2 && newCount <= 10) {
                boxCount = newCount;
                updateUI();
            }
        }

        function updateUI() {
            document.getElementById('boxCountDisplay').textContent = boxCount;
            updateCategoryTabs();
            updateWordBoxes();
            updateWordList();
            updateGenerateButton();
            updateExcludedWordsSection();
        }

        function updateCategoryTabs() {
            const tabsContainer = document.getElementById('categoryTabs');
            
            if (currentMode === 'category') {
                tabsContainer.classList.remove('hidden');
                tabsContainer.innerHTML = '';
                
                for (let i = 1; i <= boxCount; i++) {
                    const tab = document.createElement('div');
                    tab.className = `category-tab ${i === activeCategory ? 'active' : ''}`;
                    tab.textContent = `📦 ボックス${i}の単語`;
                    tab.onclick = () => setActiveCategory(i);
                    tabsContainer.appendChild(tab);
                }
            } else {
                tabsContainer.classList.add('hidden');
            }
        }

        function updateWordBoxes() {
            const container = document.getElementById('wordBoxes');
            container.innerHTML = '';
            
            for (let i = 1; i <= boxCount; i++) {
                const box = document.createElement('div');
                box.className = `word-box box${i} ${pinnedWords[i] ? 'pinned' : ''}`;
                box.onclick = () => selectBox(i);
                
                box.innerHTML = `
                    <div class="category-label">ボックス${i}</div>
                    <div class="word-text" id="word${i}">${currentWords[i] || '単語' + i}</div>
                    <div class="hint">クリックして変更</div>
                    <button class="pin-btn ${pinnedWords[i] ? 'pinned' : ''}" onclick="event.stopPropagation(); togglePin(${i})" title="この単語を固定/解除">
                        📌
                    </button>
                    <button class="dislike-btn" onclick="event.stopPropagation(); dislikeWord(${i})" title="この単語を除外">
                        👎
                    </button>
                `;
                
                container.appendChild(box);
            }
        }

        function setMode(mode) {
            currentMode = mode;
            
            // ボタンの状態を更新
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            updateUI();
            
            // 結果をリセット
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('replacementPanel').style.display = 'none';
            
            // 固定状態とピン状態をリセット
            for (let i = 1; i <= boxCount; i++) {
                currentWords[i] = '';
                pinnedWords[i] = false;
            }
            
            if (bulkSelectMode) {
                toggleBulkSelectMode();
            }
        }

        function setActiveCategory(category) {
            activeCategory = category;
            updateCategoryTabs();
            updateWordList();
        }

        function getCurrentWords() {
            if (currentMode === 'mixed') {
                return mixedWords;
            } else {
                return categoryWords[activeCategory] || [];
            }
        }

        function setInputMode(mode) {
            inputMode = mode;
            
            document.getElementById('singleModeBtn').classList.remove('active');
            document.getElementById('bulkModeBtn').classList.remove('active');
            document.getElementById(mode + 'ModeBtn').classList.add('active');
            
            const singleSection = document.getElementById('singleInputSection');
            const bulkSection = document.getElementById('bulkInputSection');
            
            if (mode === 'single') {
                singleSection.classList.remove('hidden');
                bulkSection.classList.add('hidden');
            } else {
                singleSection.classList.add('hidden');
                bulkSection.classList.remove('hidden');
            }
        }

        function addWord() {
            const input = document.getElementById('wordInput');
            const word = input.value.trim();
            const currentWords = getCurrentWords();
            
            if (word && !currentWords.includes(word)) {
                currentWords.push(word);
                input.value = '';
                updateWordList();
                updateGenerateButton();
                showNotification(`「${word}」を追加しました！`);
            }
        }

        function addBulkWords() {
            const input = document.getElementById('bulkInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            const words = parseBulkInput(text);
            const currentWords = getCurrentWords();
            let addedCount = 0;
            
            words.forEach(word => {
                if (word && !currentWords.includes(word)) {
                    currentWords.push(word);
                    addedCount++;
                }
            });
            
            if (addedCount > 0) {
                input.value = '';
                updateWordList();
                updateGenerateButton();
                showNotification(`${addedCount}個の単語を追加しました！`);
            } else {
                showNotification('追加できる新しい単語がありませんでした。', 'warning');
            }
        }

        function parseBulkInput(text) {
            return text
                .split(/[\n,\s]+/)
                .map(word => word.trim())
                .filter(word => word.length > 0);
        }

        function clearBulkInput() {
            document.getElementById('bulkInput').value = '';
        }

        function removeWord(word) {
            if (currentMode === 'mixed') {
                mixedWords = mixedWords.filter(w => w !== word);
            } else {
                const words = categoryWords[activeCategory] || [];
                categoryWords[activeCategory] = words.filter(w => w !== word);
            }
            updateWordList();
            updateGenerateButton();
            updateExcludedWordsSection();
        }

        function updateWordList() {
            const wordList = document.getElementById('wordList');
            const currentWords = getCurrentWords();
            
            if (currentWords.length === 0) {
                wordList.innerHTML = '<div class="empty-state">まだ単語が登録されていません</div>';
                return;
            }
            
            let categoryClass = '';
            if (currentMode === 'category') {
                categoryClass = `box${activeCategory}`;
            }
            
            wordList.innerHTML = currentWords.map(word => {
                const isSelected = selectedWords.has(word);
                const selectableClass = bulkSelectMode ? 'selectable' : '';
                const selectedClass = isSelected ? 'selected' : '';
                const selectionIndicator = isSelected ? '<span class="selection-indicator">✓</span>' : '';
                
                if (bulkSelectMode) {
                    return `
                        <div class="word-tag ${categoryClass} ${selectableClass} ${selectedClass}" onclick="toggleWordSelection('${word}')">
                            ${word}
                            ${selectionIndicator}
                        </div>
                    `;
                } else {
                    return `
                        <div class="word-tag ${categoryClass}">
                            ${word}
                            <button class="remove-btn" onclick="removeWord('${word}')">×</button>
                        </div>
                    `;
                }
            }).join('');
        }

        function toggleBulkSelectMode() {
            bulkSelectMode = !bulkSelectMode;
            const btn = document.getElementById('bulkSelectBtn');
            const bulkDeleteSection = document.getElementById('bulkDeleteSection');
            
            if (bulkSelectMode) {
                btn.textContent = '❌ 選択モード終了';
                btn.classList.add('active');
                bulkDeleteSection.style.display = 'block';
            } else {
                btn.textContent = '✅ まとめて削除';
                btn.classList.remove('active');
                bulkDeleteSection.style.display = 'none';
                selectedWords.clear();
            }
            
            updateWordList();
            updateSelectedCount();
        }

        function toggleWordSelection(word) {
            if (!bulkSelectMode) return;
            
            if (selectedWords.has(word)) {
                selectedWords.delete(word);
            } else {
                selectedWords.add(word);
            }
            
            updateWordList();
            updateSelectedCount();
        }

        function selectAllWords() {
            const currentWords = getCurrentWords();
            selectedWords.clear();
            currentWords.forEach(word => selectedWords.add(word));
            updateWordList();
            updateSelectedCount();
        }

        function deselectAllWords() {
            selectedWords.clear();
            updateWordList();
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const countElement = document.getElementById('selectedCount');
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            
            countElement.textContent = selectedWords.size;
            deleteBtn.disabled = selectedWords.size === 0;
        }

        function deleteSelectedWords() {
            if (selectedWords.size === 0) return;
            
            const count = selectedWords.size;
            const currentWords = getCurrentWords();
            
            // 選択された単語を削除
            selectedWords.forEach(word => {
                const index = currentWords.indexOf(word);
                if (index > -1) {
                    currentWords.splice(index, 1);
                }
            });
            
            selectedWords.clear();
            updateWordList();
            updateGenerateButton();
            updateExcludedWordsSection();
            updateSelectedCount();
            
            showNotification(`${count}個の単語を削除しました`, 'warning');
        }

        function cancelSelection() {
            toggleBulkSelectMode();
        }

        function updateGenerateButton() {
            const generateBtn = document.getElementById('generateBtn');
            
            if (currentMode === 'mixed') {
                generateBtn.disabled = mixedWords.length < boxCount;
            } else {
                let hasEnoughWords = true;
                for (let i = 1; i <= boxCount; i++) {
                    if ((categoryWords[i] || []).length === 0) {
                        hasEnoughWords = false;
                        break;
                    }
                }
                generateBtn.disabled = !hasEnoughWords;
            }
        }

        function generateRandomCombination() {
            if (currentMode === 'mixed') {
                if (mixedWords.length < boxCount) return;
                
                const shuffled = [...mixedWords].sort(() => Math.random() - 0.5);
                for (let i = 1; i <= boxCount; i++) {
                    if (!pinnedWords[i]) {
                        currentWords[i] = shuffled[i - 1] || mixedWords[Math.floor(Math.random() * mixedWords.length)];
                    }
                }
            } else {
                for (let i = 1; i <= boxCount; i++) {
                    if (!pinnedWords[i]) {
                        const words = categoryWords[i] || [];
                        if (words.length > 0) {
                            currentWords[i] = words[Math.floor(Math.random() * words.length)];
                        }
                    }
                }
            }
            
            // UIを更新
            for (let i = 1; i <= boxCount; i++) {
                const wordElement = document.getElementById(`word${i}`);
                if (wordElement) {
                    wordElement.textContent = currentWords[i];
                }
            }
            
            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('replacementPanel').style.display = 'none';
            
            // 選択状態をリセット
            for (let i = 1; i <= boxCount; i++) {
                const box = document.querySelector(`.word-box.box${i}`);
                if (box) {
                    box.classList.remove('active');
                }
            }
            selectedBox = 0;
        }

        function selectBox(boxNumber) {
            // 前の選択をリセット
            for (let i = 1; i <= boxCount; i++) {
                const box = document.querySelector(`.word-box.box${i}`);
                if (box) {
                    box.classList.remove('active');
                }
            }
            
            // 新しい選択を設定
            selectedBox = boxNumber;
            const selectedBoxElement = document.querySelector(`.word-box.box${boxNumber}`);
            if (selectedBoxElement) {
                selectedBoxElement.classList.add('active');
            }
            
            showReplacementPanel();
        }

        function showReplacementPanel() {
            const panel = document.getElementById('replacementPanel');
            const replacementWords = document.getElementById('replacementWords');
            
            let availableWords = [];
            const currentWord = currentWords[selectedBox];
            
            if (currentMode === 'mixed') {
                availableWords = mixedWords.filter(word => word !== currentWord);
            } else {
                const words = categoryWords[selectedBox] || [];
                availableWords = words.filter(word => word !== currentWord);
            }
            
            replacementWords.innerHTML = availableWords.map(word => `
                <div class="replacement-word" onclick="replaceWord('${word}')">
                    ${word}
                </div>
            `).join('');
            
            panel.style.display = 'block';
        }

        function replaceWord(newWord) {
            if (selectedBox > 0 && selectedBox <= boxCount) {
                currentWords[selectedBox] = newWord;
                const wordElement = document.getElementById(`word${selectedBox}`);
                if (wordElement) {
                    wordElement.textContent = newWord;
                }
                
                // 手動で変更した場合は固定を解除
                if (pinnedWords[selectedBox]) {
                    pinnedWords[selectedBox] = false;
                    updatePinDisplay(selectedBox, false);
                }
            }
            
            // パネルを隠す
            document.getElementById('replacementPanel').style.display = 'none';
            
            // 選択状態をリセット
            for (let i = 1; i <= boxCount; i++) {
                const box = document.querySelector(`.word-box.box${i}`);
                if (box) {
                    box.classList.remove('active');
                }
            }
            selectedBox = 0;
        }

        function togglePin(boxNumber) {
            pinnedWords[boxNumber] = !pinnedWords[boxNumber];
            updatePinDisplay(boxNumber, pinnedWords[boxNumber]);
            
            const word = currentWords[boxNumber];
            const isPinned = pinnedWords[boxNumber];
            
            showNotification(
                `「${word}」を${isPinned ? '固定' : '固定解除'}しました`,
                isPinned ? 'success' : 'warning'
            );
        }

        function updatePinDisplay(boxNumber, isPinned) {
            const box = document.querySelector(`.word-box.box${boxNumber}`);
            const btn = document.querySelector(`.word-box.box${boxNumber} .pin-btn`);
            
            if (box && btn) {
                if (isPinned) {
                    box.classList.add('pinned');
                    btn.classList.add('pinned');
                    btn.title = 'この単語の固定を解除';
                } else {
                    box.classList.remove('pinned');
                    btn.classList.remove('pinned');
                    btn.title = 'この単語を固定';
                }
            }
        }

        function dislikeWord(boxNumber) {
            const wordToExclude = currentWords[boxNumber];
            
            if (currentMode === 'mixed') {
                mixedWords = mixedWords.filter(w => w !== wordToExclude);
                if (!excludedMixedWords.includes(wordToExclude)) {
                    excludedMixedWords.push(wordToExclude);
                }
            } else {
                const words = categoryWords[boxNumber] || [];
                categoryWords[boxNumber] = words.filter(w => w !== wordToExclude);
                if (!excludedCategoryWords[boxNumber]) {
                    excludedCategoryWords[boxNumber] = [];
                }
                if (!excludedCategoryWords[boxNumber].includes(wordToExclude)) {
                    excludedCategoryWords[boxNumber].push(wordToExclude);
                }
            }
            
            updateWordList();
            updateGenerateButton();
            updateExcludedWordsSection();
            
            if (bulkSelectMode) {
                toggleBulkSelectMode();
            }
            
            generateRandomCombination();
            showNotification(`「${wordToExclude}」を除外しました`, 'warning');
        }

        function restoreWord(word) {
            if (currentMode === 'mixed') {
                excludedMixedWords = excludedMixedWords.filter(w => w !== word);
                if (!mixedWords.includes(word)) {
                    mixedWords.push(word);
                }
            } else {
                for (let i = 1; i <= boxCount; i++) {
                    if (excludedCategoryWords[i] && excludedCategoryWords[i].includes(word)) {
                        excludedCategoryWords[i] = excludedCategoryWords[i].filter(w => w !== word);
                        if (!categoryWords[i]) categoryWords[i] = [];
                        if (!categoryWords[i].includes(word)) {
                            categoryWords[i].push(word);
                        }
                    }
                }
            }
            
            updateWordList();
            updateGenerateButton();
            updateExcludedWordsSection();
            showNotification(`「${word}」を復活させました`, 'success');
        }

        function updateExcludedWordsSection() {
            const section = document.getElementById('excludedWordsSection');
            const container = document.getElementById('excludedWords');
            
            let excludedWords = [];
            if (currentMode === 'mixed') {
                excludedWords = excludedMixedWords;
            } else {
                for (let i = 1; i <= boxCount; i++) {
                    if (excludedCategoryWords[i]) {
                        excludedWords = excludedWords.concat(excludedCategoryWords[i]);
                    }
                }
            }
            
            if (excludedWords.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            container.innerHTML = excludedWords.map(word => `
                <div class="excluded-word" onclick="restoreWord('${word}')" title="クリックで復活">
                    ${word}
                </div>
            `).join('');
        }

        // プリセット機能
        function showPresetPanel() {
            const panel = document.getElementById('presetPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            updateCurrentWordsCount();
            displayPresets();
            updateBackupInfo();
        }

        function hidePresetPanel() {
            document.getElementById('presetPanel').style.display = 'none';
        }

        function updateCurrentWordsCount() {
            let totalWords = 0;
            if (currentMode === 'mixed') {
                totalWords = mixedWords.length;
            } else {
                for (let i = 1; i <= boxCount; i++) {
                    totalWords += (categoryWords[i] || []).length;
                }
            }
            document.getElementById('currentWordsCount').textContent = totalWords;
        }

        function saveCurrentPreset() {
            const nameInput = document.getElementById('presetNameInput');
            const presetName = nameInput.value.trim();
            
            if (!presetName) {
                showNotification('プリセット名を入力してください', 'warning');
                return;
            }
            
            let totalWords = 0;
            if (currentMode === 'mixed') {
                totalWords = mixedWords.length;
            } else {
                for (let i = 1; i <= boxCount; i++) {
                    totalWords += (categoryWords[i] || []).length;
                }
            }
            
            if (totalWords === 0) {
                showNotification('保存する単語がありません', 'warning');
                return;
            }
            
            // プリセット保存
            const presetId = `preset_${Date.now()}_${presetCounter++}`;
            savedPresets[presetId] = {
                name: presetName,
                mode: currentMode,
                boxCount: boxCount,
                mixedWords: [...mixedWords],
                categoryWords: {},
                excludedMixedWords: [...excludedMixedWords],
                excludedCategoryWords: {},
                createdAt: new Date().toLocaleString(),
                wordCount: totalWords
            };
            
            // カテゴリワードもコピー
            for (let i = 1; i <= 10; i++) {
                savedPresets[presetId].categoryWords[i] = categoryWords[i] ? [...categoryWords[i]] : [];
                savedPresets[presetId].excludedCategoryWords[i] = excludedCategoryWords[i] ? [...excludedCategoryWords[i]] : [];
            }
            
            savePresets();
            
            nameInput.value = '';
            displayPresets();
            showNotification(`「${presetName}」を保存しました`, 'success');
        }

        function loadPreset(presetId) {
            const preset = savedPresets[presetId];
            if (!preset) {
                showNotification('プリセットが見つかりません', 'error');
                return;
            }
            
            // モードを切り替え
            if (preset.mode !== currentMode) {
                currentMode = preset.mode;
                updateModeUI();
            }
            
            // ボックス数を設定
            boxCount = preset.boxCount || 2;
            
            // 単語をロード
            mixedWords.length = 0;
            mixedWords.push(...preset.mixedWords);
            excludedMixedWords.length = 0;
            excludedMixedWords.push(...preset.excludedMixedWords);
            
            for (let i = 1; i <= 10; i++) {
                categoryWords[i] = preset.categoryWords[i] ? [...preset.categoryWords[i]] : [];
                excludedCategoryWords[i] = preset.excludedCategoryWords[i] ? [...preset.excludedCategoryWords[i]] : [];
            }
            
            updateUI();
            hidePresetPanel();
            
            showNotification(`「${preset.name}」をロードしました (${preset.wordCount}個の単語)`, 'success');
        }

        function deletePreset(presetId) {
            const preset = savedPresets[presetId];
            if (!preset) return;
            
            if (confirm(`「${preset.name}」を削除しますか？`)) {
                delete savedPresets[presetId];
                savePresets();
                displayPresets();
                showNotification(`「${preset.name}」を削除しました`, 'warning');
            }
        }

        function displayPresets() {
            const presetList = document.getElementById('presetList');
            const presets = Object.entries(savedPresets);
            
            if (presets.length === 0) {
                presetList.innerHTML = '<div class="no-presets">保存されたプリセットはありません</div>';
                return;
            }
            
            presetList.innerHTML = presets.map(([id, preset]) => `
                <div class="preset-item">
                    <div class="preset-item-header">
                        <div class="preset-name">${preset.name}</div>
                    </div>
                    <div class="preset-info">
                        ${preset.wordCount}個の単語 | ${preset.mode === 'mixed' ? 'ミックスモード' : 'カテゴリモード'} | ボックス数: ${preset.boxCount} | ${preset.createdAt}
                    </div>
                    <div class="preset-actions">
                        <button class="load-preset-btn" onclick="loadPreset('${id}')">ロード</button>
                        <button class="delete-preset-btn" onclick="deletePreset('${id}')">削除</button>
                    </div>
                </div>
            `).join('');
        }

        function updateModeUI() {
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            if (currentMode === 'mixed') {
                document.querySelector('.mode-btn').classList.add('active');
            } else {
                document.querySelectorAll('.mode-btn')[1].classList.add('active');
            }
        }

        function savePresets() {
            // メモリ内に保持（ブラウザ環境ではlocalStorageは使用不可）
        }

        function loadPresets() {
            // 初期化のみ
            savedPresets = {};
        }

        // バックアップシステム
        function initializeBackupSystem() {
            loadBackups();
            startAutoBackup();
            updateBackupInfo();
        }

        function startAutoBackup() {
            // 5分ごとに自動バックアップ
            autoBackupInterval = setInterval(() => {
                createAutoBackup();
            }, 300000); // 5分
        }

        function createAutoBackup() {
            const backupId = `auto_${Date.now()}_${backupCounter++}`;
            const currentData = getCurrentAppState();
            
            backupData[backupId] = {
                type: 'auto',
                name: `自動バックアップ ${new Date().toLocaleString()}`,
                data: currentData,
                createdAt: new Date().toLocaleString(),
                timestamp: Date.now()
            };
            
            cleanupOldAutoBackups();
            
            lastAutoBackup = new Date().toLocaleString();
            saveBackups();
            updateBackupInfo();
        }

        function createManualBackup() {
            const backupId = `manual_${Date.now()}_${backupCounter++}`;
            const currentData = getCurrentAppState();
            
            backupData[backupId] = {
                type: 'manual',
                name: `手動バックアップ ${new Date().toLocaleString()}`,
                data: currentData,
                createdAt: new Date().toLocaleString(),
                timestamp: Date.now()
            };
            
            saveBackups();
            updateBackupInfo();
            showNotification('手動バックアップを作成しました', 'success');
        }

        function getCurrentAppState() {
            return {
                boxCount: boxCount,
                mixedWords: [...mixedWords],
                categoryWords: {...categoryWords},
                excludedMixedWords: [...excludedMixedWords],
                excludedCategoryWords: {...excludedCategoryWords},
                savedPresets: {...savedPresets},
                currentMode: currentMode,
                activeCategory: activeCategory,
                currentWords: {...currentWords},
                pinnedWords: {...pinnedWords}
            };
        }

        function restoreFromBackup(backupId) {
            const backup = backupData[backupId];
            if (!backup) {
                showNotification('バックアップが見つかりません', 'error');
                return;
            }
            
            if (!confirm(`「${backup.name}」を復元しますか？現在のデータは失われます。`)) {
                return;
            }
            
            const data = backup.data;
            
            // データを復元
            boxCount = data.boxCount || 2;
            mixedWords.length = 0;
            mixedWords.push(...data.mixedWords);
            categoryWords = {...data.categoryWords};
            excludedMixedWords.length = 0;
            excludedMixedWords.push(...data.excludedMixedWords);
            excludedCategoryWords = {...data.excludedCategoryWords};
            
            savedPresets = {...data.savedPresets};
            currentMode = data.currentMode;
            activeCategory = data.activeCategory;
            currentWords = {...data.currentWords};
            pinnedWords = {...data.pinnedWords};
            
            // UIを更新
            updateModeUI();
            updateUI();
            displayPresets();
            
            hideBackupList();
            showNotification(`「${backup.name}」から復元しました`, 'success');
        }

        function exportBackup() {
            const exportData = {
                backups: backupData,
                appState: getCurrentAppState(),
                exportDate: new Date().toLocaleString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `game-word-combiner-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('バックアップをエクスポートしました', 'success');
        }

        function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    if (!importData.backups || !importData.appState) {
                        throw new Error('無効なバックアップファイルです');
                    }
                    
                    if (confirm('バックアップをインポートしますか？現在のデータに追加されます。')) {
                        Object.assign(backupData, importData.backups);
                        saveBackups();
                        updateBackupInfo();
                        showNotification('バックアップをインポートしました', 'success');
                    }
                } catch (error) {
                    showNotification('バックアップファイルの読み込みに失敗しました', 'error');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        function showBackupList() {
            const panel = document.getElementById('backupListPanel');
            panel.style.display = 'block';
            displayBackups();
        }

        function hideBackupList() {
            document.getElementById('backupListPanel').style.display = 'none';
        }

        function displayBackups() {
            const backupList = document.getElementById('backupList');
            const backups = Object.entries(backupData).sort((a, b) => b[1].timestamp - a[1].timestamp);
            
            if (backups.length === 0) {
                backupList.innerHTML = '<div class="no-backups">バックアップがありません</div>';
                return;
            }
            
            backupList.innerHTML = backups.map(([id, backup]) => `
                <div class="backup-item">
                    <div class="backup-item-header">
                        <div class="backup-name">${backup.name}</div>
                        <div class="backup-type">${backup.type === 'auto' ? '自動' : '手動'}</div>
                    </div>
                    <div class="backup-info-detail">
                        作成日時: ${backup.createdAt}
                    </div>
                    <div class="backup-actions-detail">
                        <button class="restore-btn" onclick="restoreFromBackup('${id}')">復元</button>
                        <button class="delete-backup-btn" onclick="deleteBackup('${id}')">削除</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteBackup(backupId) {
            const backup = backupData[backupId];
            if (!backup) return;
            
            if (confirm(`「${backup.name}」を削除しますか？`)) {
                delete backupData[backupId];
                saveBackups();
                updateBackupInfo();
                displayBackups();
                showNotification('バックアップを削除しました', 'warning');
            }
        }

        function cleanupOldAutoBackups() {
            const autoBackups = Object.entries(backupData)
                .filter(([id, backup]) => backup.type === 'auto')
                .sort((a, b) => b[1].timestamp - a[1].timestamp);
            
            if (autoBackups.length > 10) {
                autoBackups.slice(10).forEach(([id]) => {
                    delete backupData[id];
                });
            }
        }

        function updateBackupInfo() {
            const autoBackupTime = document.getElementById('autoBackupTime');
            const backupCount = document.getElementById('backupCount');
            
            autoBackupTime.textContent = lastAutoBackup || '未実行';
            backupCount.textContent = Object.keys(backupData).length;
        }

        function saveBackups() {
            // メモリ内に保持
        }

        function loadBackups() {
            backupData = {};
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#00b894' : type === 'warning' ? '#fdcb6e' : '#ff6b6b'};
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                z-index: 1000;
                animation: slideInRight 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Enterキーで単語を追加
        document.getElementById('wordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addWord();
            }
        });

        // アプリ初期化
        initializeApp();
    </script>
</body>
</html>
